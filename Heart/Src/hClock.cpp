/********************************************************************
	created:	2008/06/17
	created:	17:6:2008   21:01
	filename: 	hClock.cpp
	author:		James Moran
	
	purpose:	
*********************************************************************/

#include "Common.h"
#include "Heart.h"
#include "hClock.h"

namespace Heart
{
namespace hClock
{
namespace
{
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	hInt64			Time_;
	hInt64			TimeMS_;
	hInt64			LastTime_;
	hUint32			TickMS_;
	hFloat			TickS_;
	hInt64			StartTime_;
	hInt64			Freq_;
	hInt64			FreqMicro_;
}

	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////

	hFloat			elapsed()
	{
		return static_cast< hFloat >( (Time_ - StartTime_) / 1000.0f );
	}

	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////

	hUint32			elapsedMS()
	{
		return static_cast< hUint32 >(Time_ - StartTime_);
	}

	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////

	hUint32			deltams()
	{
		return TickMS_;
	}
	
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////

	hFloat			fdeltams()
	{
		return static_cast< hFloat >( TickMS_ );
	}

	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////

	hFloat			Delta()
	{
		return TickS_;
	}

	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////

	hUint32			hours()
	{
		return ( ( (hUint32)elapsed() / 60 ) / 60 );
	}

	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////

	hUint32			mins()
	{
		return ( (hUint32)elapsed() / 60 ) - ( hours() * 60 );
	}
	
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////

	hUint32			secs()
	{
		return (hUint32)elapsed() - ( mins() * 60 );
	}

	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////

	void hClock::Update()
	{
		if ( Freq_ != 0 )
		{
			LastTime_ = Time_;

			QueryPerformanceCounter( reinterpret_cast< LARGE_INTEGER* >( &Time_ ) );

			Time_ /= Freq_;
			TickMS_ = (hUint32)( Time_ - LastTime_ );
			TickS_ = TickMS_ / 1000.0f;
			TimeMS_ = Time_;
		}
	}

	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////

	void hClock::Initialise()
	{
		Time_ = 0;
		LastTime_ = 0;
		TickS_ = 0.0f;
		TickMS_ = 0;

		QueryPerformanceFrequency( reinterpret_cast< LARGE_INTEGER*>( &Freq_ ) );

		Freq_		/= 1000;
		FreqMicro_	/= 10000;

		QueryPerformanceCounter( reinterpret_cast< LARGE_INTEGER* >( &StartTime_ ) );

		StartTime_ /= Freq_;
	}

	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////

	void hClock::BeginTimer( hTimer& timer )
	{
		hUint64 time;

		QueryPerformanceCounter( reinterpret_cast< LARGE_INTEGER* >( &time ) );

		timer.beginT_ = time / FreqMicro_;
	}

	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////
	//////////////////////////////////////////////////////////////////////////

	void hClock::EndTimer( hTimer& timer )
	{
		hUint64 time;

		QueryPerformanceCounter( reinterpret_cast< LARGE_INTEGER* >( &time ) );

		timer.deltaT_ = (hUint32)(timer.beginT_ - ( time / FreqMicro_ ));
	}
}// namespace hClock
}// namespace Heart